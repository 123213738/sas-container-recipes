version: "2"
settings:

  conductor:
    # The Conductor container does the heavy lifting, and provides a portable
    # Python runtime for building your target containers. It should be derived
    # from the same distribution as you're building your target containers with.
    base: centos:7
    # roles_path:   # Specify a local path containing Ansible roles
    # volumes:      # Provide a list of volumes to mount
    # environment:  # List or mapping of environment variables

  vars_files:
  - everything.yml
  #
  #
  # Set the name of the project. Defaults to basename of the project directory.
  # For built services, concatenated with service name to form the built image name.
  project_name: "sas-viya"

  # The deployment_output_path is mounted to the Conductor container, and the 
  # `run` and `deployment` commands then write generated Ansible playbooks to it.
  # deployment_output_path: ./ansible-deployment

  # When using the k8s or openshift engines, use the following to authorize with the API.
  # Values set here will be passed to the Ansible modules. Any file paths will be mounted
  # to the conductor container, allowing the `run` command to access the API.
  #k8s_auth:
    # path to a K8s config file
    #config_file:
    # name of a context found within the config file
    #context:
    # URL for accessing the K8s API
    #host:
    # An API authentication token
    #api_key:
    # Path to a ca cert file
    #ssl_ca_cert:
    # Path to a cert file
    #cert_file:
    # Path to a key file
    #key_file:
    # boolean, indicating if SSL certs should be validated
    #verify_ssl:

  # When using the k8s or openshift engines, use the following to set the namespace.
  # If not set, the project name will be used. For openshift, the namespace maps to a project,
  # and description and display_name are supported.
  #k8s_namespace:
  #  name:
  #  description:
  #  display_name:

services: 
  consul:
    from: "centos:7"
    roles:
    - consul
    ports:
    - "8500:8500"
    - "8501:8501"
    - "8600:8600"
    - "8400:8400"
    - "8301:8301"
    - "8302:8302"
    - "8300:8300"
    entrypoint: ["/opt/sas/viya/home/bin/consul-entrypoint.sh"]
    volumes:
    - static-content:/consul
    dev_overrides:
      environment:
        - "SAS_DEBUG=1"
    deployment_overrides:
      environment:
        - "CONSUL_BOOTSTRAP_EXPECT=1"
        - "CONSUL_CLIENT_ADDRESS=0.0.0.0"
        - "CONSUL_DATA_DIR=/consul/data"
        - "CONSUL_DATACENTER_NAME={{ DEPLOYMENT_LABEL }}"
        - "CONSUL_KEY_VALUE_DATA_ENC="
        - "CONSUL_SERVER_FLAG=true"
        - "CONSUL_UI_FLAG=false"
      resources:
        limits:
          - "memory=4000Mi"
        requests:
          - "memory=512Mi"
      secrets:
        - "CONSUL_TOKENS_CLIENT=tobeusedfordemosonlyclnt"
        - "CONSUL_TOKENS_ENCRYPTION=9eV9uJXG0r8o3xTDH6+ykg=="
        - "CONSUL_TOKENS_MANAGEMENT=tobeusedfordemosonlymgmt"
      volumes:
        - "data=/consul"
        - "log=/opt/sas/viya/config/var/log"

  httpproxy:
    from: "centos:7"
    roles:
    - httpproxy
    ports:
    - "80:80"
    - "443:443"
    entrypoint: ["/opt/sas/viya/home/bin/httpproxy-entrypoint.sh"]
    volumes:
    - static-content:/httpproxy
    dev_overrides:
      environment:
        - "SAS_DEBUG=1"
    deployment_overrides:
      resources:
        limits:
        - "memory=512Mi"
        requests:
        - "memory=10Mi"
      volumes:
        - "log=/opt/sas/viya/config/var/log"

  pgpoolc:
    from: "centos:7"
    roles:
    - pgpoolc
    ports:
    - "5431:5431"
    entrypoint: ["/opt/sas/viya/home/bin/pgpoolc-entrypoint.sh"]
    dev_overrides:
      environment:
        - "SAS_DEBUG=1"
    deployment_overrides:
      environment:
        - "SASPOSTGRESDBSIZE=large"
        - "PG_VOLUME=/database/data"
      resources:
        limits:
        - "memory=12000Mi"
        requests:
        - "memory=512Mi"
      secrets:
        - "SAS_DEFAULT_PGPWD=Go4thsas"
        - "SASPOSTGRESREPLPWD=Go4thsas"
      volumes:
        - "log=/opt/sas/viya/config/var/log"

  rabbitmq:
    from: "centos:7"
    roles:
    - rabbitmq
    ports:
    - "5672:5672"
    - "15672:15672"
    entrypoint: ["/opt/sas/viya/home/bin/rabbitmq-entrypoint.sh"]
    volumes:
    - static-content:/rabbitmq
    dev_overrides:
      environment:
        - "SAS_DEBUG=1"
    deployment_overrides:
      resources:
        limits:
        - "memory=1024Mi"
        requests:
        - "memory=1024Mi"
      volumes:
        - "data=/rabbitmq/data"
        - "log=/opt/sas/viya/config/var/log"

  sasdatasvrc:
    from: "centos:7"
    roles:
    - sasdatasvrc
    ports:
    - "5432:5432"
    entrypoint: ["/opt/sas/viya/home/bin/sasdatasvrc-entrypoint.sh"]
    volumes:
    - static-content:/database/data
    dev_overrides:
      environment:
        - "SAS_DEBUG=1"
    deployment_overrides:
      environment:
        - "SASPOSTGRESDBSIZE=large"
        - "PG_VOLUME=/database/data"
      resources:
        limits:
        - "memory=12000Mi"
        requests:
        - "memory=1024Mi"
      secrets:
        - "SAS_DEFAULT_PGPWD=Go4thsas"
        - "SASPOSTGRESREPLPWD=Go4thsas"
      volumes:
        - "data=/database/data"
        - "log=/opt/sas/viya/config/var/log"

